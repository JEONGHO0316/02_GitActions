name: CI/CD Pipeline (Auto Deploy)

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

env:
  AWS_REGION: ap-northeast-2
  #  아까 만든 ECR 리포지토리 이름으로 통일 
  ECR_REPOSITORY: gitactions
  ECR_REGISTRY: 639242342449.dkr.ecr.ap-northeast-2.amazonaws.com
  IMAGE_TAG: v${{ github.run_number }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Java 17 세팅 추가 (빌드 안정성 확보)
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # AWS 로그인
    - name: Configure AWS and Login to ECR
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    - uses: aws-actions/amazon-ecr-login@v2

    # 1. 빌드 및 ECR 업로드
    - name: Build, tag, and push image to Amazon ECR
      run: |
        chmod +x mvnw
        ./mvnw clean package -DskipTests

        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

        # latest 태그 업데이트
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    # 2. K8s YAML 파일 수정
    - name: Update Deployment YAML with new image tag
      run: |
        WAS_YAML_PATH="k8s/was-deployment.yaml"

        # sed 패턴 변경: 기존 이름이 뭐든 간에 ECR 주소 라인을 통째로 교체
        sed -i "s|image: .*dkr.ecr.*|image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" $WAS_YAML_PATH

        # 확인
        cat $WAS_YAML_PATH

    # 3. Git 커밋 & 푸시
    - name: Commit and Push Updated YAML
      uses: EndBug/add-and-commit@v9
      with:
        message: 'GitOps: Deploy new image version ${{ env.IMAGE_TAG }}'
        add: 'k8s/was-deployment.yaml' 
